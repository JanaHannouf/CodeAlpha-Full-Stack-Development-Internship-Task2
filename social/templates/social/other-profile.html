{% extends 'social/base.html' %}
{% load static %}
{% block content %}
    <!-- Profile Section -->
    <section id="user-profile">
        <div class="profile-wrapper">
            <div class="profile-banner">
                <img src="{{ profile.banner.url }}" alt="Profile Banner" class="banner-img">
            </div>
            <div class="profile-details">
                <div class="profile-img-container">
                    <img src="{{ profile.picture.url }}" alt="Profile Picture" class="profile-img">
                </div>
                <div class="profile-info">
                    {% if profile.name %}
                        <h2 class="profile-name">{{ profile.name }}</h2>
                    {% endif %}
                        <p class="profile-username">@{{ user.username }}</p>
                    {% if profile.bio %}
                        <p class="profile-bio">{{ profile.bio }}</p>
                    {% endif %}
                    {% if profile.bith_date %}
                        <p class="profile-birthdate"><strong>Date of Birth:</strong> {{ profile.birth_date }}</p>
                    {% endif %}
                    {% if profile.location %}
                        <p class="profile-location"><strong>Location:</strong> {{ profile.location }}</p>
                    {% endif %}
                    <div class="profile-stats">
                        <span><strong>{{ post_count }}</strong> Post{{ post_count|pluralize }}</span>
                        <span><strong>300</strong> Followers</span>
                        <span><strong>180</strong> Following</span>
                    </div>
                    <div class="profile-actions">
                        <button class="follow-btn">Follow</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- User's Posts Section -->
    <section id="user-posts">
        <h2 class="section-title">User's Posts</h2>
        <div class="posts-grid">
            {% for post in posts %}
                <div class="post-card">
                    <div class="post-head">
                        <img src="{% static 'asset/images/profile.jpg' %}" alt="User" class="post-avatar">
                        <div class="post-user-details">
                            <h4 class="post-username">@{{ post.author }}</h4>
                            <p class="post-timestamp">{{ post.created_on }}</p>
                        </div>
                    </div>
                    <div class="post-media">
                        <div class="image-carousel" id="carousel-{{ forloop.counter }}">
                            <div class="image-content">
                                <img id="current-image-{{ forloop.counter }}" src="{{ post.image.url }}" alt="Post Image" class="post-image">
                            </div>
                            {% if post.post_images.count > 1 %}
                                <button class="prev-btn">❮</button>
                                <button class="next-btn">❯</button>
                            {% endif %}
                        </div>
                        <p class="post-caption">{{ post.caption }}</p>
                    </div>
                    <div class="post-interactions">
                        <button class="like-button"> <i class="fa fa-heart"></i> </button>
                        <span class="like-count">25</span>
                        <button class="comment-button"> <i class="fa fa-comment"></i> </button>
                        <span class="comment-count">2 comments</span>
                    </div>
                    <div class="comment-section">
                        {% for comment in comments %}
                            <div class="comment">
                                <img src="{% static 'asset/images/profile.jpg' %}" alt="User Avatar" class="comment-avatar">
                                <div class="comment-content">
                                    <div class="comment-header">
                                        <div class="comment-username">{{ comment.author }}</div>
                                        <div class="comment-date">{{ comment.created_on }}</div>
                                    </div>
                                    <div class="comment-text">{{ comment.comment }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>

    <script>
        document.querySelectorAll('.image-carousel').forEach((carousel, index) => {
            const postIndex = index + 1; // Each post will have a unique index

            // Fetch the main image for the post
            const mainImageUrl = document.getElementById(`current-image-${postIndex}`).src; // Main image
            const additionalImages = [
                {% for post in post_list %}
                    {% if post.post_images.count > 1 %}  <!-- Only fetch additional images if more than one exists -->
                        {% for image in post.post_images.all %}
                            "{{ image.images.url }}",
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            ].filter(Boolean); // Filter out empty or undefined values

            const images = [mainImageUrl, ...additionalImages].filter(Boolean); // Combine main and additional images

            let currentIndex = 0;

            // Check if there are valid images
            if (images.length > 0) {
                const currentImageElement = carousel.querySelector('img');
                const prevBtn = carousel.querySelector('.prev-btn');
                const nextBtn = carousel.querySelector('.next-btn');

                // Function to change image
                function changeImage(direction) {
                    currentIndex = (currentIndex + direction + images.length) % images.length; // Wrap around index
                    displayImage(images[currentIndex]); // Update displayed image
                }

                // Function to display image
                function displayImage(imageUrl) {
                    currentImageElement.src = imageUrl;
                    currentImageElement.alt = "Post Image";
                }

                // Initial image display
                displayImage(images[currentIndex]);

                // Activate buttons if there are multiple images
                if (images.length > 1) {
                    if (prevBtn && nextBtn) {
                        prevBtn.addEventListener('click', () => changeImage(-1)); // Previous button
                        nextBtn.addEventListener('click', () => changeImage(1)); // Next button
                    }
                } else {
                    // Hide navigation buttons if only one image
                    if (prevBtn) prevBtn.style.display = 'none';
                    if (nextBtn) nextBtn.style.display = 'none';
                }
            }
        });
    </script>
    
{% endblock content %}